<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI ç©å¶ä¼´ä¾£</title>
    <style>
        /* --- ç®€å•çš„ CSS æ ·å¼ï¼Œè®©ç•Œé¢çœ‹èµ·æ¥åƒä¸ª APP --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            color: #333;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        h1 { margin-bottom: 10px; font-size: 24px; }
        p { color: #666; margin-bottom: 30px; }

        /* çŠ¶æ€æŒ‡ç¤ºç¯ */
        .status-dot {
            height: 12px; width: 12px;
            background-color: #ccc;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-text { font-size: 14px; color: #888; margin-bottom: 20px; display: block; }

        /* æŒ‰é’®é€šç”¨æ ·å¼ */
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn:active { transform: scale(0.98); }

        /* è¿æ¥æŒ‰é’® */
        .btn-connect { background-color: #007AFF; color: white; }
        .btn-connect:hover { background-color: #0062cc; }

        /* æŠšæ‘¸æŒ‰é’® */
        .btn-action { 
            background-color: #34C759; 
            color: white; 
            display: none; /* é»˜è®¤éšè—ï¼Œè¿ä¸Šæ‰æ˜¾ç¤º */
        }
        .btn-action:disabled { background-color: #ccc; cursor: not-allowed; }

        /* è°ƒè¯•æ—¥å¿— (å¯é€‰ï¼Œæ¼”ç¤ºæ—¶å¯ä»¥éšè—) */
        #console {
            margin-top: 20px;
            font-size: 12px;
            color: #999;
            text-align: left;
            height: 100px;
            overflow-y: auto;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 8px;
            display: none; /* å¦‚æœä¸æƒ³çœ‹æ—¥å¿—ï¼Œä¿æŒ none */
        }
    </style>
</head>
<body>

    <div class="container">
        <div style="font-size: 60px; margin-bottom: 20px;">ğŸ§¸</div>
        
        <h1>æˆ‘çš„ AI ç©å¶</h1>
        <p>ç‚¹å‡»è¿æ¥ï¼Œä½“éªŒæ‹ŸçœŸè§¦è§‰äº’åŠ¨</p>

        <span class="status-text">
            <span id="dot" class="status-dot"></span>
            <span id="statusMsg">æœªè¿æ¥è®¾å¤‡</span>
        </span>

        <button id="btnConnect" class="btn btn-connect" onclick="connectToDoll()">
            ğŸ“¡ æœç´¢å¹¶è¿æ¥
        </button>

        <button id="btnNod" class="btn btn-action" onclick="sendNod()">
            ğŸ‘‹ æŠšæ‘¸ç©å¶å¤´éƒ¨
        </button>

        <div id="console"></div>
    </div>

    <script>
        // === é…ç½®åŒºåŸŸï¼šå¿…é¡»ä¸ ESP32 ä»£ç ä¸€è‡´ ===
        const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const CHAR_UUID    = "beb5483e-36e1-4688-b7f5-ea07361b26a8";

        // å…¨å±€å˜é‡
        let deviceHandle;
        let charHandle;

        // 1. è¿æ¥è®¾å¤‡çš„æ ¸å¿ƒé€»è¾‘
        async function connectToDoll() {
            try {
                updateStatus("æ­£åœ¨æœç´¢è“ç‰™...", "orange");
                
                // æµè§ˆå™¨å¼¹çª—æœç´¢è®¾å¤‡
                deviceHandle = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'ESP32_Doll' }], // åªæ˜¾ç¤ºæˆ‘ä»¬çš„ç©å¶
                    optionalServices: [SERVICE_UUID]   // å¿…é¡»å£°æ˜æœåŠ¡
                });

                updateStatus("è®¾å¤‡å·²é€‰ä¸­ï¼Œæ­£åœ¨è¿æ¥...", "blue");
                
                // è¿æ¥ GATT æœåŠ¡å™¨
                const server = await deviceHandle.gatt.connect();
                
                // è·å–æœåŠ¡
                const service = await server.getPrimaryService(SERVICE_UUID);
                
                // è·å–ç‰¹å¾å€¼ (è¯»å†™é€šé“)
                charHandle = await service.getCharacteristic(CHAR_UUID);

                // è¿æ¥æˆåŠŸï¼
                onConnected();

                // ç›‘å¬æ„å¤–æ–­å¼€
                deviceHandle.addEventListener('gattserverdisconnected', onDisconnected);

            } catch (error) {
                console.error(error);
                // å¦‚æœæ˜¯ç”¨æˆ·å–æ¶ˆï¼Œå°±ä¸æŠ¥é”™
                if (error.name !== 'NotFoundError') {
                    updateStatus("è¿æ¥å¤±è´¥: " + error.message, "red");
                } else {
                    updateStatus("ç”¨æˆ·å–æ¶ˆè¿æ¥", "#ccc");
                }
            }
        }

        // 2. å‘é€æŒ‡ä»¤é€»è¾‘
        async function sendNod() {
            if (!charHandle) return;
            
            try {
                // æŒ‰é’®æ·»åŠ ç‚¹å‡»åé¦ˆæ•ˆæœ
                const btn = document.getElementById('btnNod');
                const originalText = btn.innerHTML;
                btn.innerHTML = "âœ¨ å‘é€æŒ‡ä»¤ä¸­...";
                btn.disabled = true;

                // å‘é€ "nod" å­—ç¬¦ä¸²
                let encoder = new TextEncoder('utf-8');
                await charHandle.writeValue(encoder.encode("nod"));
                
                log("æŒ‡ä»¤ [nod] å·²å‘é€");

                // æ¢å¤æŒ‰é’®çŠ¶æ€
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 500); // 0.5ç§’åæ¢å¤

            } catch (error) {
                log("å‘é€å¤±è´¥: " + error);
                updateStatus("å‘é€å¤±è´¥ï¼Œè¯·é‡è¿", "red");
            }
        }

        // --- è¾…åŠ©å‡½æ•° ---

        function onConnected() {
            updateStatus("âœ… å·²è¿æ¥åˆ°ç©å¶", "#34C759");
            document.getElementById('btnConnect').style.display = 'none'; // éšè—è¿æ¥æŒ‰é’®
            document.getElementById('btnNod').style.display = 'flex';     // æ˜¾ç¤ºäº’åŠ¨æŒ‰é’®
        }

        function onDisconnected() {
            updateStatus("ğŸ”´ è¿æ¥å·²æ–­å¼€", "red");
            document.getElementById('btnConnect').style.display = 'flex';
            document.getElementById('btnNod').style.display = 'none';
            charHandle = null;
        }

        function updateStatus(text, color) {
            document.getElementById('statusMsg').innerText = text;
            document.getElementById('dot').style.backgroundColor = color;
            log(text);
        }

        function log(msg) {
            const box = document.getElementById('console');
            box.innerHTML += `<div>${new Date().toLocaleTimeString()} - ${msg}</div>`;
            // å¦‚æœéœ€è¦æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼ŒæŠŠ CSS é‡Œçš„ #console display:none æ”¹æ‰
        }
    </script>
</body>
</html>
